# Controller モジュール解説

このディレクトリには、Live2D Cubism SDK for Webを使用したWebアプリケーションの制御に関するTypeScriptファイルが含まれています。

## ファイル一覧と説明

### 1. main.ts

**エントリーポイント**

アプリケーションのエントリーポイントです。ブラウザのロードイベントとアンロードイベントを処理します。

- `window.addEventListener('load')`: ページロード時に`LAppDelegate`を初期化して実行
- `window.addEventListener('beforeunload')`: ページ離脱時にリソースを解放

### 2. lappdefine.ts

**定数定義ファイル**

アプリケーション全体で使用される定数や設定値を定義します。

- **キャンバス設定**: `CanvasSize`, `CanvasNum`
- **ビュー設定**: スケール、論理座標の範囲
- **リソースパス**: `ResourcesPath`, 背景画像、UI画像のファイル名
- **モデル定義**: `ModelDir`配列にモデルディレクトリ名を列挙
- **モーショングループ**: `MotionGroupIdle`, `MotionGroupTapBody`
- **ヒットエリア**: `HitAreaNameHead`, `HitAreaNameBody`
- **優先度定数**: モーション再生の優先度定義
- **デバッグ設定**: ログレベルや検証オプション

### 3. lappdelegate.ts

**アプリケーション管理クラス**

Cubism SDKの管理を行うメインクラスです。シングルトンパターンで実装されています。

主な機能：

- Cubism Frameworkの初期化と解放
- ポインタイベント（タッチ、マウス）の処理とサブデリゲートへの配信
- メインループの実行（`run()`メソッド）
- リサイズイベントの処理
- 複数のサブデリゲート（キャンバス）の管理

### 4. lappsubdelegate.ts

**キャンバス操作管理クラス**

各キャンバスに関連する操作を取りまとめます。

主な機能：

- WebGLコンテキストの初期化（`LAppGlManager`経由）
- テクスチャマネージャ、Live2Dマネージャ、ビューの管理
- キャンバスのリサイズ監視（`ResizeObserver`使用）
- フレームバッファの設定
- シェーダープログラムの作成
- 描画ループの更新処理

### 5. lappglmanager.ts

**WebGL管理クラス**

WebGLコンテキストの初期化と管理を行います。

- `initialize()`: WebGL2コンテキストの取得
- `getGl()`: WebGLコンテキストへのアクセス提供
- WebGL2非対応時のエラーハンドリング

### 6. lapplive2dmanager.ts

**Live2Dモデル管理クラス**

Live2Dモデルの生成、破棄、切り替え、操作を管理します。

主な機能：

- モデルのロードと解放
- タップイベントの処理（ヒットテスト）
  - 頭部タップ：ランダム表情
  - 体タップ：ランダムモーション再生
- ドラッグ処理
- モデルの更新と描画
- シーン切り替え（モデル切り替え）
- ビューマトリックスの設定

### 7. lappmodel.ts

**Live2Dモデルクラス**

個別のLive2Dモデルを表現するクラスで、`CubismUserModel`を継承しています（1019行の大規模ファイル）。

主な機能：

- モデルアセットの非同期ロード
  - `.model3.json`の読み込み
  - モデルデータ（.moc3）
  - テクスチャ
  - モーション
  - 表情
  - 物理演算
  - ポーズ
  - ユーザーデータ
- モーションの再生制御
- 表情の設定
- まばたき（`CubismEyeBlink`）
- 呼吸エフェクト（`CubismBreath`）
- リップシンク
- ヒットテスト
- モデルの更新と描画
- レンダーターゲットの管理

### 8. lappview.ts

**描画ビュークラス**

画面の描画処理を管理します。

主な機能：

- ビューマトリックスの初期化と設定
- デバイス座標からスクリーン座標への変換
- スプライト（背景、UIボタンなど）の管理
- タッチマネージャの統合
- 画面のスケールと移動範囲の制御
- Live2Dマネージャへの描画指示

### 9. lappsprite.ts

**スプライト描画クラス**

2D画像（背景、UIボタン等）を描画するためのクラスです。

主な機能：

- テクスチャの管理
- 頂点バッファ、UVバッファ、インデックスバッファの作成
- WebGLでのスプライト描画
- 座標変換（デバイス座標→正規化座標）
- ヒットテスト（クリック判定）

### 10. lapptexturemanager.ts

**テクスチャ管理クラス**

画像の読み込みと管理を行います。

主な機能：

- PNG画像の非同期ロード
- テクスチャキャッシュ機能
- プリマルチプライアルファの処理
- ミップマップの生成
- テクスチャ情報の保持（`TextureInfo`）
- 既に読み込まれたテクスチャの再利用

### 11. lappwavfilehandler.ts

**WAVファイルハンドラ**

WAVオーディオファイルの読み込みと解析を行い、リップシンク用のRMS値を計算します。

主な機能：

- WAVファイルの非同期ロード
- WAVファイル形式の解析（RIFF、fmtチャンク、dataチャンク）
- PCMデータの抽出
- RMS（二乗平均平方根）の計算
- 時間経過に応じたサンプリングオフセットの更新
- リップシンクアニメーションのデータ提供

### 12. touchmanager.ts

**タッチ/マウス入力管理クラス**

タッチやマウスの入力を管理し、ドラッグやフリック操作を検出します。

主な機能：

- タッチ開始位置の記録
- ドラッグ中の座標追跡
- フリック距離の計算
- シングルタッチ/マルチタッチの判定
- スケール計算（ピンチ操作用）
- 座標のゲッター群

## クラス間の関係

```tree
main.ts
  └→ LAppDelegate (シングルトン)
      ├→ LAppSubdelegate[] (複数のキャンバス管理)
      │   ├→ LAppGlManager (WebGL)
      │   ├→ LAppTextureManager (テクスチャ)
      │   ├→ LAppLive2DManager (モデル管理)
      │   │   └→ LAppModel[] (個別モデル)
      │   │       └→ LAppWavFileHandler (音声/リップシンク)
      │   └→ LAppView (描画)
      │       ├→ LAppSprite[] (UI要素)
      │       └→ TouchManager (入力)
      └→ LAppDefine (定数)
```

## 使用技術

- **Live2D Cubism SDK for Web**: Live2Dモデルのレンダリング
- **WebGL 2.0**: 3Dグラフィックス描画
- **TypeScript**: 型安全な開発
- **非同期処理**: Fetch API, Promise, async/await
- **イベント駆動**: ブラウザイベント、ResizeObserver
- **デザインパターン**: シングルトン、オブザーバー

## 開発時の注意点

1. **非同期ロード**: すべてのアセット（モデル、テクスチャ、モーション等）は非同期でロードされます
2. **リソース解放**: ページ離脱時やモデル切り替え時に適切にリソースを解放する必要があります
3. **座標系**: デバイス座標、スクリーン座標、モデル座標の変換に注意が必要です
4. **WebGL2必須**: WebGL2に対応していないブラウザでは動作しません
5. **model3.json**: モデル定義ファイルとディレクトリ名を一致させる必要があります
